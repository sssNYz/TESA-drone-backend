generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RawMessage {
  id         BigInt   @id @default(autoincrement())
  topic      String
  payload    String   // เก็บ JSON ดิบ (string)
  receivedAt DateTime @default(now())
  // สำหรับ reprocess/debug
  parseOk    Boolean  @default(false)
  error      String?
  @@index([receivedAt])
}

model DroneDetection {
  id         BigInt   @id @default(autoincrement())
  receivedAt DateTime @default(now())      // เวลาที่เซิร์ฟเวอร์รับ
  deviceTs   DateTime                      // เวลาจาก payload.timestamp
  droneId    String
  latDeg     Float
  lonDeg     Float
  altM       Float
  speedMps   Float
  radiusM    Float?
  angleDeg   Float?
  // NEW: extra fields for frame format
  sourceId   String?
  type       String?
  confidence Float?
  bboxX      Int?
  bboxY      Int?
  bboxW      Int?
  bboxH      Int?

  // link to Frame (optional for legacy)
  frameId    BigInt?
  frame      Frame?   @relation(fields: [frameId], references: [id])

  rawId      BigInt?                       // อ้างอิง RawMessage เพื่อ trace
  @@index([deviceTs])
  @@index([droneId, deviceTs(sort: Desc)])
  @@index([frameId])
}

model Frame {
  id           BigInt   @id @default(autoincrement())
  receivedAt   DateTime @default(now())
  frameNo      Int
  deviceTs     DateTime
  sourceId     String
  imageBase64  String?
  objectsCount Int

  // relation to detections in this frame
  detections   DroneDetection[]
  binaries     FrameBinary[]
  
  @@index([deviceTs])
  @@index([sourceId, deviceTs])
}

// --- Fake Drone live state models ---
model Drone {
  id              String   @id
  lastSeenAt      DateTime @default(now())
  lastLat         Float
  lastLon         Float
  lastAltM        Float
  lastSpeedMS     Float
  lastHeadingDeg  Float
  batteryPct      Float
  signalOk        Boolean
  signalLossProb  Float
  updatedAt       DateTime @updatedAt

  readings        DroneReading[]
  trips           Trip[]
}

model DroneReading {
  id             String   @id @default(cuid())
  droneId        String
  drone          Drone    @relation(fields: [droneId], references: [id])
  ts             DateTime
  lat            Float
  lon            Float
  altM           Float
  speedMS        Float
  headingDeg     Float
  batteryPct     Float
  signalOk       Boolean
  signalLossProb Float
  tripId         BigInt?
  trip           Trip?    @relation(fields: [tripId], references: [id])

  @@index([droneId, ts(sort: Desc)])
  @@index([ts])
  @@index([tripId])
}

enum AreaKind {
  FRIENDLY
  ANAMY
}

model Area {
  id        String   @id @default(cuid())
  name      String
  kind      AreaKind @default(FRIENDLY)
  points    Json
  createdAt DateTime @default(now())

  @@index([kind])
}

model FrameBinary {
  id        BigInt   @id @default(autoincrement())
  frameId   BigInt
  frame     Frame    @relation(fields: [frameId], references: [id], onDelete: Cascade)
  mime      String
  bytes     Bytes
  size      Int
  createdAt DateTime @default(now())

  @@index([frameId])
  @@index([createdAt])
}

model Trip {
  id                BigInt       @id @default(autoincrement())
  droneId           String
  drone             Drone        @relation(fields: [droneId], references: [id])
  waypoints         Json         // [{lat,lon,alt_m?}, ...]
  speedMS           Float
  startsAt          DateTime     @default(now())
  estimatedSeconds  Int
  estimatedEndAt    DateTime

  readings          DroneReading[]

  @@index([droneId, startsAt])
}
